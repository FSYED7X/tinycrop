'use strict';

var debounce = require('./debounce.js');
var BackgroundLayer = require('./BackgroundLayer.js');
var ImageLayer = require('./ImageLayer.js');
var SelectionLayer = require('./SelectionLayer.js');
var Image = require('./Image.js');
var Listeners = require('./Listeners.js');

var DEFAULT_CANVAS_WIDTH = 400;
var DEFAULT_CANVAS_HEIGHT = 300;

var Crop = function Crop(opts) {
  this.parent = typeof opts.parent === 'string' ? document.querySelector(opts.parent) : opts.parent;

  this.canvas = document.createElement('canvas');
  this.context = this.canvas.getContext('2d');
  this.boundsOpts = opts.bounds || { width: '100%', height: 'auto' };
  opts.selection = opts.selection || {};
  this.debounceResize = opts.debounceResize !== undefined ? opts.debounceResize : true;
  this.listeners = Listeners.create();

  this.parent.appendChild(this.canvas);

  this.backgroundLayer = BackgroundLayer.create({
    parent: this,
    context: this.context,
    colors: opts.backgroundColors || ['#fff', '#f0f0f0']
  });

  this.imageLayer = ImageLayer.create({
    parent: this,
    context: this.context,
    image: this.image
  });

  this.selectionLayer = SelectionLayer.create({
    parent: this,
    context: this.context,
    target: this.imageLayer,
    aspectRatio: opts.selection.aspectRatio,
    minWidth: opts.selection.minWidth,
    minHeight: opts.selection.minHeight,
    x: opts.selection.x,
    y: opts.selection.y,
    width: opts.selection.width,
    height: opts.selection.height,
    handle: {
      color: opts.selection.color,
      activeColor: opts.selection.activeColor
    }
  });

  var listeners = this.listeners;
  var paint = this.paint.bind(this);

  this.selectionLayer.on('start', function (region) {
    paint();
    listeners.notify('start', region);
  }).on('move', function (region) {
    listeners.notify('move', region);
  }).on('resize', function (region) {
    listeners.notify('resize', region);
  }).on('change', function (region) {
    paint();
    listeners.notify('change', region);
  }).on('end', function (region) {
    paint();
    listeners.notify('end', region);
  });

  window.addEventListener('resize', this.debounceResize ? debounce(this.revalidateAndPaint.bind(this), 100) : this.revalidateAndPaint.bind(this));

  this.setImage(opts.image);

  this.revalidateAndPaint();
};

Crop.create = function (opts) {
  return new Crop(opts);
};

Crop.prototype.on = function (type, fn) {
  this.listeners.on(type, fn);
  return this;
};

Crop.prototype.off = function (type, fn) {
  this.listeners.off(type, fn);
  return this;
};

Crop.prototype.revalidateAndPaint = function () {
  this.revalidate();
  this.paint();
};

Crop.prototype.revalidate = function () {
  var parent = this.parent;
  var image = this.image;

  var boundsWidth = this.boundsOpts.width;
  var boundsHeight = this.boundsOpts.height;
  var width = 0;
  var height = 0;

  if (isInteger(boundsWidth)) {
    width = boundsWidth;
  } else if (parent && isPercent(boundsWidth)) {
    width = Math.round(parent.clientWidth * getPercent(boundsWidth) / 100);
  } else {
    width = DEFAULT_CANVAS_WIDTH;
  }

  if (isInteger(boundsHeight)) {
    height = boundsHeight;
  } else if (isPercent(boundsHeight)) {
    height = Math.round(width * getPercent(boundsHeight) / 100);
  } else if (image && image.hasLoaded && isAuto(boundsHeight)) {
    height = Math.floor(width / image.getAspectRatio());
  } else {
    height = DEFAULT_CANVAS_HEIGHT;
  }

  this.resizeCanvas(width, height);

  this.backgroundLayer.revalidate();
  this.imageLayer.revalidate();
  this.selectionLayer.revalidate();
};

Crop.prototype.paint = function () {
  var g = this.context;

  g.save();
  g.scale(this.ratio, this.ratio);

  this.backgroundLayer.paint();

  if (this.image && this.image.hasLoaded) {
    this.imageLayer.paint();
    this.selectionLayer.paint();
  }

  g.restore();
};

Crop.prototype.resizeCanvas = function (width, height) {
  var context = this.context;
  var canvas = this.canvas;
  this.ratio = 1;

  if (!context.webkitBackingStorePixelRatio) {
    this.ratio = window.devicePixelRatio || 1;
  }

  this.width = width;
  this.height = height;

  canvas.width = this.width * this.ratio;
  canvas.height = this.height * this.ratio;
};

Crop.prototype.setImage = function (source) {
  var image = Image.create(source).on('load', function () {
    this.selectionLayer.onImageLoad();
    this.revalidateAndPaint();
  }.bind(this)).on('error', function (e) {
    console.error(e);
  });

  this.imageLayer.setImage(image);
  this.image = image;
  this.revalidateAndPaint();
};

Crop.prototype.getImage = function () {
  return this.image;
};

Crop.prototype.setAspectRatio = function (aspectRatio) {
  this.selectionLayer.setAspectRatio(aspectRatio);
  this.revalidateAndPaint();
};

Crop.prototype.setBounds = function (opts) {
  this.boundsOpts = opts;
  this.revalidateAndPaint();
};

Crop.prototype.setBackgroundColors = function (colors) {
  this.backgroundLayer.setColors(colors);
  this.revalidateAndPaint();
};

Crop.prototype.dispose = noop;

function noop() {};

function isPercent(v) {
  if (typeof v !== 'string') {
    return false;
  }

  if (v.length < 1) {
    return false;
  }

  if (v[v.length - 1] === '%') {
    return true;
  }
}

function getPercent(v) {
  if (!isPercent(v)) {
    return 0;
  }

  return v.slice(0, -1);
}

function isAuto(v) {
  return v === 'auto';
}

function isInteger(v) {
  return typeof v === 'number' && Math.round(v) === v;
}

module.exports = Crop;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Dcm9wLmpzIl0sIm5hbWVzIjpbImRlYm91bmNlIiwicmVxdWlyZSIsIkJhY2tncm91bmRMYXllciIsIkltYWdlTGF5ZXIiLCJTZWxlY3Rpb25MYXllciIsIkltYWdlIiwiTGlzdGVuZXJzIiwiREVGQVVMVF9DQU5WQVNfV0lEVEgiLCJERUZBVUxUX0NBTlZBU19IRUlHSFQiLCJDcm9wIiwib3B0cyIsInBhcmVudCIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsImNhbnZhcyIsImNyZWF0ZUVsZW1lbnQiLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImJvdW5kc09wdHMiLCJib3VuZHMiLCJ3aWR0aCIsImhlaWdodCIsInNlbGVjdGlvbiIsImRlYm91bmNlUmVzaXplIiwidW5kZWZpbmVkIiwibGlzdGVuZXJzIiwiY3JlYXRlIiwiYXBwZW5kQ2hpbGQiLCJiYWNrZ3JvdW5kTGF5ZXIiLCJjb2xvcnMiLCJiYWNrZ3JvdW5kQ29sb3JzIiwiaW1hZ2VMYXllciIsImltYWdlIiwic2VsZWN0aW9uTGF5ZXIiLCJ0YXJnZXQiLCJhc3BlY3RSYXRpbyIsIm1pbldpZHRoIiwibWluSGVpZ2h0IiwieCIsInkiLCJoYW5kbGUiLCJjb2xvciIsImFjdGl2ZUNvbG9yIiwicGFpbnQiLCJiaW5kIiwib24iLCJyZWdpb24iLCJub3RpZnkiLCJ3aW5kb3ciLCJhZGRFdmVudExpc3RlbmVyIiwicmV2YWxpZGF0ZUFuZFBhaW50Iiwic2V0SW1hZ2UiLCJwcm90b3R5cGUiLCJ0eXBlIiwiZm4iLCJvZmYiLCJyZXZhbGlkYXRlIiwiYm91bmRzV2lkdGgiLCJib3VuZHNIZWlnaHQiLCJpc0ludGVnZXIiLCJpc1BlcmNlbnQiLCJNYXRoIiwicm91bmQiLCJjbGllbnRXaWR0aCIsImdldFBlcmNlbnQiLCJoYXNMb2FkZWQiLCJpc0F1dG8iLCJmbG9vciIsImdldEFzcGVjdFJhdGlvIiwicmVzaXplQ2FudmFzIiwiZyIsInNhdmUiLCJzY2FsZSIsInJhdGlvIiwicmVzdG9yZSIsIndlYmtpdEJhY2tpbmdTdG9yZVBpeGVsUmF0aW8iLCJkZXZpY2VQaXhlbFJhdGlvIiwic291cmNlIiwib25JbWFnZUxvYWQiLCJlIiwiY29uc29sZSIsImVycm9yIiwiZ2V0SW1hZ2UiLCJzZXRBc3BlY3RSYXRpbyIsInNldEJvdW5kcyIsInNldEJhY2tncm91bmRDb2xvcnMiLCJzZXRDb2xvcnMiLCJkaXNwb3NlIiwibm9vcCIsInYiLCJsZW5ndGgiLCJzbGljZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsV0FBV0MsUUFBUSxlQUFSLENBQWY7QUFDQSxJQUFJQyxrQkFBa0JELFFBQVEsc0JBQVIsQ0FBdEI7QUFDQSxJQUFJRSxhQUFhRixRQUFRLGlCQUFSLENBQWpCO0FBQ0EsSUFBSUcsaUJBQWlCSCxRQUFRLHFCQUFSLENBQXJCO0FBQ0EsSUFBSUksUUFBUUosUUFBUSxZQUFSLENBQVo7QUFDQSxJQUFJSyxZQUFZTCxRQUFRLGdCQUFSLENBQWhCOztBQUVBLElBQUlNLHVCQUF1QixHQUEzQjtBQUNBLElBQUlDLHdCQUF3QixHQUE1Qjs7QUFFQSxJQUFJQyxPQUFPLFNBQVBBLElBQU8sQ0FBVUMsSUFBVixFQUFnQjtBQUN6QixPQUFLQyxNQUFMLEdBQWMsT0FBT0QsS0FBS0MsTUFBWixLQUF1QixRQUF2QixHQUFrQ0MsU0FBU0MsYUFBVCxDQUF1QkgsS0FBS0MsTUFBNUIsQ0FBbEMsR0FBd0VELEtBQUtDLE1BQTNGOztBQUVBLE9BQUtHLE1BQUwsR0FBY0YsU0FBU0csYUFBVCxDQUF1QixRQUF2QixDQUFkO0FBQ0EsT0FBS0MsT0FBTCxHQUFlLEtBQUtGLE1BQUwsQ0FBWUcsVUFBWixDQUF1QixJQUF2QixDQUFmO0FBQ0EsT0FBS0MsVUFBTCxHQUFrQlIsS0FBS1MsTUFBTCxJQUFlLEVBQUNDLE9BQU8sTUFBUixFQUFnQkMsUUFBUSxNQUF4QixFQUFqQztBQUNBWCxPQUFLWSxTQUFMLEdBQWlCWixLQUFLWSxTQUFMLElBQWtCLEVBQW5DO0FBQ0EsT0FB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QUF5QjVCLEtBQUtDLEtBQUwsQ0FBVzJCLENBQVgsTUFBa0JBLENBQWxEO0FBQ0Q7O0FBRURHLE9BQU9DLE9BQVAsR0FBaUJwRixJQUFqQiIsImZpbGUiOiJDcm9wLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGRlYm91bmNlID0gcmVxdWlyZSgnLi9kZWJvdW5jZS5qcycpXG52YXIgQmFja2dyb3VuZExheWVyID0gcmVxdWlyZSgnLi9CYWNrZ3JvdW5kTGF5ZXIuanMnKVxudmFyIEltYWdlTGF5ZXIgPSByZXF1aXJlKCcuL0ltYWdlTGF5ZXIuanMnKVxudmFyIFNlbGVjdGlvbkxheWVyID0gcmVxdWlyZSgnLi9TZWxlY3Rpb25MYXllci5qcycpXG52YXIgSW1hZ2UgPSByZXF1aXJlKCcuL0ltYWdlLmpzJylcbnZhciBMaXN0ZW5lcnMgPSByZXF1aXJlKCcuL0xpc3RlbmVycy5qcycpXG5cbnZhciBERUZBVUxUX0NBTlZBU19XSURUSCA9IDQwMFxudmFyIERFRkFVTFRfQ0FOVkFTX0hFSUdIVCA9IDMwMFxuXG52YXIgQ3JvcCA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gIHRoaXMucGFyZW50ID0gdHlwZW9mIG9wdHMucGFyZW50ID09PSAnc3RyaW5nJyA/IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0cy5wYXJlbnQpIDogb3B0cy5wYXJlbnRcblxuICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpXG4gIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJylcbiAgdGhpcy5ib3VuZHNPcHRzID0gb3B0cy5ib3VuZHMgfHwge3dpZHRoOiAnMTAwJScsIGhlaWdodDogJ2F1dG8nfVxuICBvcHRzLnNlbGVjdGlvbiA9IG9wdHMuc2VsZWN0aW9uIHx8IHt9XG4gIHRoaXMuZGVib3VuY2VSZXNpemUgPSBvcHRzLmRlYm91bmNlUmVzaXplICE9PSB1bmRlZmluZWQgPyBvcHRzLmRlYm91bmNlUmVzaXplIDogdHJ1ZVxuICB0aGlzLmxpc3RlbmVycyA9IExpc3RlbmVycy5jcmVhdGUoKVxuXG4gIHRoaXMucGFyZW50LmFwcGVuZENoaWxkKHRoaXMuY2FudmFzKVxuXG4gIHRoaXMuYmFja2dyb3VuZExheWVyID0gQmFja2dyb3VuZExheWVyLmNyZWF0ZSh7XG4gICAgcGFyZW50OiB0aGlzLFxuICAgIGNvbnRleHQ6IHRoaXMuY29udGV4dCxcbiAgICBjb2xvcnM6IG9wdHMuYmFja2dyb3VuZENvbG9ycyB8fCBbJyNmZmYnLCAnI2YwZjBmMCddXG4gIH0pXG5cbiAgdGhpcy5pbWFnZUxheWVyID0gSW1hZ2VMYXllci5jcmVhdGUoe1xuICAgIHBhcmVudDogdGhpcyxcbiAgICBjb250ZXh0OiB0aGlzLmNvbnRleHQsXG4gICAgaW1hZ2U6IHRoaXMuaW1hZ2VcbiAgfSlcblxuICB0aGlzLnNlbGVjdGlvbkxheWVyID0gU2VsZWN0aW9uTGF5ZXIuY3JlYXRlKHtcbiAgICBwYXJlbnQ6IHRoaXMsXG4gICAgY29udGV4dDogdGhpcy5jb250ZXh0LFxuICAgIHRhcmdldDogdGhpcy5pbWFnZUxheWVyLFxuICAgIGFzcGVjdFJhdGlvOiBvcHRzLnNlbGVjdGlvbi5hc3BlY3RSYXRpbyxcbiAgICBtaW5XaWR0aDogb3B0cy5zZWxlY3Rpb24ubWluV2lkdGgsXG4gICAgbWluSGVpZ2h0OiBvcHRzLnNlbGVjdGlvbi5taW5IZWlnaHQsXG4gICAgeDogb3B0cy5zZWxlY3Rpb24ueCxcbiAgICB5OiBvcHRzLnNlbGVjdGlvbi55LFxuICAgIHdpZHRoOiBvcHRzLnNlbGVjdGlvbi53aWR0aCxcbiAgICBoZWlnaHQ6IG9wdHMuc2VsZWN0aW9uLmhlaWdodCxcbiAgICBoYW5kbGU6IHtcbiAgICAgIGNvbG9yOiBvcHRzLnNlbGVjdGlvbi5jb2xvcixcbiAgICAgIGFjdGl2ZUNvbG9yOiBvcHRzLnNlbGVjdGlvbi5hY3RpdmVDb2xvclxuICAgIH1cbiAgfSlcblxuICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNcbiAgdmFyIHBhaW50ID0gdGhpcy5wYWludC5iaW5kKHRoaXMpXG5cbiAgdGhpcy5zZWxlY3Rpb25MYXllclxuICAgIC5vbihcbiAgICAgICdzdGFydCcsXG4gICAgICBmdW5jdGlvbiAocmVnaW9uKSB7XG4gICAgICAgIHBhaW50KClcbiAgICAgICAgbGlzdGVuZXJzLm5vdGlmeSgnc3RhcnQnLCByZWdpb24pXG4gICAgICB9XG4gICAgKVxuICAgIC5vbihcbiAgICAgICdtb3ZlJyxcbiAgICAgIGZ1bmN0aW9uIChyZWdpb24pIHtcbiAgICAgICAgbGlzdGVuZXJzLm5vdGlmeSgnbW92ZScsIHJlZ2lvbilcbiAgICAgIH1cbiAgICApXG4gICAgLm9uKFxuICAgICAgJ3Jlc2l6ZScsXG4gICAgICBmdW5jdGlvbiAocmVnaW9uKSB7XG4gICAgICAgIGxpc3RlbmVycy5ub3RpZnkoJ3Jlc2l6ZScsIHJlZ2lvbilcbiAgICAgIH1cbiAgICApXG4gICAgLm9uKFxuICAgICAgJ2NoYW5nZScsXG4gICAgICBmdW5jdGlvbiAocmVnaW9uKSB7XG4gICAgICAgIHBhaW50KClcbiAgICAgICAgbGlzdGVuZXJzLm5vdGlmeSgnY2hhbmdlJywgcmVnaW9uKVxuICAgICAgfVxuICAgIClcbiAgICAub24oXG4gICAgICAnZW5kJyxcbiAgICAgIGZ1bmN0aW9uIChyZWdpb24pIHtcbiAgICAgICAgcGFpbnQoKVxuICAgICAgICBsaXN0ZW5lcnMubm90aWZ5KCdlbmQnLCByZWdpb24pXG4gICAgICB9XG4gICAgKVxuXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxuICAgICdyZXNpemUnLFxuICAgIHRoaXMuZGVib3VuY2VSZXNpemVcbiAgICAgID8gZGVib3VuY2UodGhpcy5yZXZhbGlkYXRlQW5kUGFpbnQuYmluZCh0aGlzKSwgMTAwKVxuICAgICAgOiB0aGlzLnJldmFsaWRhdGVBbmRQYWludC5iaW5kKHRoaXMpXG4gIClcblxuICB0aGlzLnNldEltYWdlKG9wdHMuaW1hZ2UpXG5cbiAgdGhpcy5yZXZhbGlkYXRlQW5kUGFpbnQoKVxufVxuXG5Dcm9wLmNyZWF0ZSA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gIHJldHVybiBuZXcgQ3JvcChvcHRzKVxufVxuXG5Dcm9wLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICh0eXBlLCBmbikge1xuICB0aGlzLmxpc3RlbmVycy5vbih0eXBlLCBmbilcbiAgcmV0dXJuIHRoaXNcbn1cblxuQ3JvcC5wcm90b3R5cGUub2ZmID0gZnVuY3Rpb24gKHR5cGUsIGZuKSB7XG4gIHRoaXMubGlzdGVuZXJzLm9mZih0eXBlLCBmbilcbiAgcmV0dXJuIHRoaXNcbn1cblxuQ3JvcC5wcm90b3R5cGUucmV2YWxpZGF0ZUFuZFBhaW50ID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLnJldmFsaWRhdGUoKVxuICB0aGlzLnBhaW50KClcbn1cblxuQ3JvcC5wcm90b3R5cGUucmV2YWxpZGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIHBhcmVudCA9IHRoaXMucGFyZW50XG4gIHZhciBpbWFnZSA9IHRoaXMuaW1hZ2VcblxuICB2YXIgYm91bmRzV2lkdGggPSB0aGlzLmJvdW5kc09wdHMud2lkdGhcbiAgdmFyIGJvdW5kc0hlaWdodCA9IHRoaXMuYm91bmRzT3B0cy5oZWlnaHRcbiAgdmFyIHdpZHRoID0gMFxuICB2YXIgaGVpZ2h0ID0gMFxuXG4gIGlmIChpc0ludGVnZXIoYm91bmRzV2lkdGgpKSB7XG4gICAgd2lkdGggPSBib3VuZHNXaWR0aFxuICB9IGVsc2UgaWYgKHBhcmVudCAmJiBpc1BlcmNlbnQoYm91bmRzV2lkdGgpKSB7XG4gICAgd2lkdGggPSBNYXRoLnJvdW5kKHBhcmVudC5jbGllbnRXaWR0aCAqIGdldFBlcmNlbnQoYm91bmRzV2lkdGgpIC8gMTAwKVxuICB9IGVsc2Uge1xuICAgIHdpZHRoID0gREVGQVVMVF9DQU5WQVNfV0lEVEhcbiAgfVxuXG4gIGlmIChpc0ludGVnZXIoYm91bmRzSGVpZ2h0KSkge1xuICAgIGhlaWdodCA9IGJvdW5kc0hlaWdodFxuICB9IGVsc2UgaWYgKGlzUGVyY2VudChib3VuZHNIZWlnaHQpKSB7XG4gICAgaGVpZ2h0ID0gTWF0aC5yb3VuZCh3aWR0aCAqIGdldFBlcmNlbnQoYm91bmRzSGVpZ2h0KSAvIDEwMClcbiAgfSBlbHNlIGlmIChpbWFnZSAmJiBpbWFnZS5oYXNMb2FkZWQgJiYgaXNBdXRvKGJvdW5kc0hlaWdodCkpIHtcbiAgICBoZWlnaHQgPSBNYXRoLmZsb29yKHdpZHRoIC8gaW1hZ2UuZ2V0QXNwZWN0UmF0aW8oKSlcbiAgfSBlbHNlIHtcbiAgICBoZWlnaHQgPSBERUZBVUxUX0NBTlZBU19IRUlHSFRcbiAgfVxuXG4gIHRoaXMucmVzaXplQ2FudmFzKHdpZHRoLCBoZWlnaHQpXG5cbiAgdGhpcy5iYWNrZ3JvdW5kTGF5ZXIucmV2YWxpZGF0ZSgpXG4gIHRoaXMuaW1hZ2VMYXllci5yZXZhbGlkYXRlKClcbiAgdGhpcy5zZWxlY3Rpb25MYXllci5yZXZhbGlkYXRlKClcbn1cblxuQ3JvcC5wcm90b3R5cGUucGFpbnQgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBnID0gdGhpcy5jb250ZXh0XG5cbiAgZy5zYXZlKClcbiAgZy5zY2FsZSh0aGlzLnJhdGlvLCB0aGlzLnJhdGlvKVxuXG4gIHRoaXMuYmFja2dyb3VuZExheWVyLnBhaW50KClcblxuICBpZiAodGhpcy5pbWFnZSAmJiB0aGlzLmltYWdlLmhhc0xvYWRlZCkge1xuICAgIHRoaXMuaW1hZ2VMYXllci5wYWludCgpXG4gICAgdGhpcy5zZWxlY3Rpb25MYXllci5wYWludCgpXG4gIH1cblxuICBnLnJlc3RvcmUoKVxufVxuXG5Dcm9wLnByb3RvdHlwZS5yZXNpemVDYW52YXMgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkge1xuICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dFxuICB2YXIgY2FudmFzID0gdGhpcy5jYW52YXNcbiAgdGhpcy5yYXRpbyA9IDFcblxuICBpZiAoIWNvbnRleHQud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbykge1xuICAgIHRoaXMucmF0aW8gPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxXG4gIH1cblxuICB0aGlzLndpZHRoID0gd2lkdGhcbiAgdGhpcy5oZWlnaHQgPSBoZWlnaHRcblxuICBjYW52YXMud2lkdGggPSB0aGlzLndpZHRoICogdGhpcy5yYXRpb1xuICBjYW52YXMuaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKiB0aGlzLnJhdGlvXG59XG5cbkNyb3AucHJvdG90eXBlLnNldEltYWdlID0gZnVuY3Rpb24gKHNvdXJjZSkge1xuICB2YXIgaW1hZ2UgPSBJbWFnZS5jcmVhdGUoc291cmNlKVxuICAgIC5vbihcbiAgICAgICdsb2FkJyxcbiAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25MYXllci5vbkltYWdlTG9hZCgpXG4gICAgICAgIHRoaXMucmV2YWxpZGF0ZUFuZFBhaW50KClcbiAgICAgIH0uYmluZCh0aGlzKVxuICAgIClcbiAgICAub24oXG4gICAgICAnZXJyb3InLFxuICAgICAgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgfVxuICAgIClcblxuICB0aGlzLmltYWdlTGF5ZXIuc2V0SW1hZ2UoaW1hZ2UpXG4gIHRoaXMuaW1hZ2UgPSBpbWFnZVxuICB0aGlzLnJldmFsaWRhdGVBbmRQYWludCgpXG59XG5cbkNyb3AucHJvdG90eXBlLmdldEltYWdlID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gdGhpcy5pbWFnZVxufVxuXG5Dcm9wLnByb3RvdHlwZS5zZXRBc3BlY3RSYXRpbyA9IGZ1bmN0aW9uIChhc3BlY3RSYXRpbykge1xuICB0aGlzLnNlbGVjdGlvbkxheWVyLnNldEFzcGVjdFJhdGlvKGFzcGVjdFJhdGlvKVxuICB0aGlzLnJldmFsaWRhdGVBbmRQYWludCgpXG59XG5cbkNyb3AucHJvdG90eXBlLnNldEJvdW5kcyA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gIHRoaXMuYm91bmRzT3B0cyA9IG9wdHNcbiAgdGhpcy5yZXZhbGlkYXRlQW5kUGFpbnQoKVxufVxuXG5Dcm9wLnByb3RvdHlwZS5zZXRCYWNrZ3JvdW5kQ29sb3JzID0gZnVuY3Rpb24gKGNvbG9ycykge1xuICB0aGlzLmJhY2tncm91bmRMYXllci5zZXRDb2xvcnMoY29sb3JzKVxuICB0aGlzLnJldmFsaWRhdGVBbmRQYWludCgpXG59XG5cbkNyb3AucHJvdG90eXBlLmRpc3Bvc2UgPSBub29wXG5cbmZ1bmN0aW9uIG5vb3AgKCkge307XG5cbmZ1bmN0aW9uIGlzUGVyY2VudCAodikge1xuICBpZiAodHlwZW9mIHYgIT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAodi5sZW5ndGggPCAxKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAodlt2Lmxlbmd0aCAtIDFdID09PSAnJScpIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBlcmNlbnQgKHYpIHtcbiAgaWYgKCFpc1BlcmNlbnQodikpIHtcbiAgICByZXR1cm4gMFxuICB9XG5cbiAgcmV0dXJuIHYuc2xpY2UoMCwgLTEpXG59XG5cbmZ1bmN0aW9uIGlzQXV0byAodikge1xuICByZXR1cm4gdiA9PT0gJ2F1dG8nXG59XG5cbmZ1bmN0aW9uIGlzSW50ZWdlciAodikge1xuICByZXR1cm4gdHlwZW9mIHYgPT09ICdudW1iZXInICYmIE1hdGgucm91bmQodikgPT09IHZcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDcm9wXG4iXX0=