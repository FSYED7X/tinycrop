'use strict';

var Rectangle = require('./Rectangle.js');

var Selection = function Selection(opts) {
  this.target = opts.target || null;
  this.bounds = Rectangle.create(0, 0, 0, 0);
  this.boundsPx = Rectangle.create(0, 0, 0, 0);
  this.region = Rectangle.create(0, 0, 0, 0);

  this.initialOpts = {
    x: opts.x,
    y: opts.y,
    width: opts.width,
    height: opts.height
  };

  this.aspectRatio = opts.aspectRatio;
  this.minWidth = opts.minWidth !== undefined ? opts.minWidth : 100;
  this.minHeight = opts.minHeight !== undefined ? opts.minHeight : 100;

  this.boundsMinWidth = 0;
  this.boundsMinHeight = 0;

  this._delta = { x: 0, h: 0 };
};

Object.defineProperties(Selection.prototype, {
  x: {
    get: function get() {
      return this.bounds.x;
    },
    set: function set(v) {
      this.bounds.x = v;
    }
  },
  y: {
    get: function get() {
      return this.bounds.y;
    },
    set: function set(v) {
      this.bounds.y = v;
    }
  },
  width: {
    get: function get() {
      return this.bounds.width;
    },
    set: function set(v) {
      this.bounds.width = v;
    }
  },
  height: {
    get: function get() {
      return this.bounds.height;
    },
    set: function set(v) {
      this.bounds.height = v;
    }
  },
  left: {
    get: function get() {
      return this.bounds.x;
    },
    set: function set(v) {
      this.bounds.left = v;
    }
  },
  top: {
    get: function get() {
      return this.bounds.y;
    },
    set: function set(v) {
      this.bounds.top = v;
    }
  },
  right: {
    get: function get() {
      return this.bounds.right;
    },
    set: function set(v) {
      this.bounds.right = v;
    }
  },
  bottom: {
    get: function get() {
      return this.bounds.bottom;
    },
    set: function set(v) {
      this.bounds.bottom = v;
    }
  }
});

Selection.prototype.getBoundsLengthForRegion = function (regionLen) {
  return regionLen / this.region.width * this.width;
};

Selection.prototype.moveBy = function (dx, dy) {
  var bounds = this.bounds;
  var target = this.target;

  bounds.x = Math.min(Math.max(bounds.x + dx, target.bounds.x), target.bounds.x + target.bounds.width - bounds.width);
  bounds.y = Math.min(Math.max(bounds.y + dy, target.bounds.y), target.bounds.y + target.bounds.height - bounds.height);

  return this.updateRegionFromBounds();
};

Selection.prototype.resizeBy = function (dx, dy, p) {
  var delta = this._delta;
  var aspectRatio = this.aspectRatio;
  var bounds = this.bounds;
  var boundsMinWidth = this.boundsMinWidth;
  var boundsMinHeight = this.boundsMinHeight;
  var target = this.target;

  function calculateDelta(x, y) {
    delta.width = bounds.width + x;
    delta.height = bounds.height + y;

    delta.width = Math.max(boundsMinWidth, delta.width);
    delta.height = Math.max(boundsMinHeight, delta.height);

    if (aspectRatio) {
      if (delta.width / delta.height > aspectRatio) {
        delta.width = delta.height * aspectRatio;
      } else {
        delta.height = delta.width / aspectRatio;
      }
    }

    delta.width -= bounds.width;
    delta.height -= bounds.height;

    return delta;
  }

  if (p[0] === 'n') {
    dy = Math.min(dy, this.top - target.bounds.top);
  } else if (p[0] === 's') {
    dy = Math.min(dy, target.bounds.bottom - this.bottom);
  }

  if (p[1] === 'w') {
    dx = Math.min(dx, this.left - target.bounds.left);
  } else if (p[1] === 'e') {
    dx = Math.min(dx, target.bounds.right - this.right);
  }

  delta = calculateDelta(dx, dy);

  switch (p) {
    case 'nw':
      this.left -= delta.width;
      this.top -= delta.height;
      break;
    case 'ne':
      this.right += delta.width;
      this.top -= delta.height;
      break;
    case 'sw':
      this.left -= delta.width;
      this.bottom += delta.height;
      break;
    case 'se':
      this.right += delta.width;
      this.bottom += delta.height;
      break;
  }

  return this.updateRegionFromBounds();
};

Selection.prototype.autoSizeRegion = function () {
  var target = this.target;
  var region = this.region;
  var aspectRatio = this.aspectRatio;
  var initialOpts = this.initialOpts;
  var beforeX = region.x;
  var beforeY = region.y;
  var beforeWidth = region.width;
  var beforeHeight = region.height;

  region.x = initialOpts.x !== undefined ? initialOpts.x : 0;
  region.y = initialOpts.y !== undefined ? initialOpts.y : 0;

  region.width = initialOpts.width !== undefined ? initialOpts.width : target.image.width;
  region.height = initialOpts.height !== undefined ? initialOpts.height : target.image.height;

  if (aspectRatio) {
    if (region.width / region.height > aspectRatio) {
      region.width = region.height * aspectRatio;
    } else {
      region.height = region.width / aspectRatio;
    }
  }

  if (initialOpts.x === undefined) {
    region.centerX = target.image.width * 0.5;
  }

  if (initialOpts.y === undefined) {
    region.centerY = target.image.height * 0.5;
  }

  region.round();

  this.updateBoundsFromRegion();

  return region.x !== beforeX || region.y !== beforeY || region.width !== beforeWidth || region.height !== beforeHeight;
};

Selection.prototype.updateRegionFromBounds = function () {
  var target = this.target;
  var region = this.region;
  var bounds = this.bounds;
  var beforeX = region.x;
  var beforeY = region.y;
  var beforeWidth = region.width;
  var beforeHeight = region.height;

  region.x = target.image.width * (bounds.x - target.bounds.x) / target.bounds.width;
  region.y = target.image.height * (bounds.y - target.bounds.y) / target.bounds.height;

  region.width = target.image.width * (bounds.width / target.bounds.width);
  region.height = target.image.height * (bounds.height / target.bounds.height);

  region.round();

  return region.x !== beforeX || region.y !== beforeY || region.width !== beforeWidth || region.height !== beforeHeight;
};

Selection.prototype.updateBoundsFromRegion = function () {
  var target = this.target;
  var region = this.region;
  var bounds = this.bounds;

  if (target.image) {
    bounds.x = target.bounds.x + target.bounds.width * (region.x / target.image.width);
    bounds.y = target.bounds.y + target.bounds.height * (region.y / target.image.height);
    bounds.width = target.bounds.width * (region.width / target.image.width);
    bounds.height = target.bounds.height * (region.height / target.image.height);
  }

  this.boundsMinWidth = this.getBoundsLengthForRegion(this.minWidth);
  this.boundsMinHeight = this.getBoundsLengthForRegion(this.minHeight);
};

Selection.prototype.isInside = function (point) {
  return this.bounds.isInside(point);
};

Selection.create = function (opts) {
  return new Selection(opts);
};

module.exports = Selection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZWxlY3Rpb24uanMiXSwibmFtZXMiOlsiUmVjdGFuZ2xlIiwicmVxdWlyZSIsIlNlbGVjdGlvbiIsIm9wdHMiLCJ0YXJnZXQiLCJib3VuZHMiLCJjcmVhdGUiLCJib3VuZHNQeCIsInJlZ2lvbiIsImluaXRpYWxPcHRzIiwieCIsInkiLCJ3aWR0aCIsImhlaWdodCIsImFzcGVjdFJhdGlvIiwibWluV2lkdGgiLCJ1bmRlZmluZWQiLCJtaW5IZWlnaHQiLCJib3VuZHNNaW5XaWR0aCIsImJvdW5kc01pbkhlaWdodCIsIl9kZWx0YSIsImgiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0aWVzIiwicHJvdG90eXBlIiwiZ2V0Iiwic2V0IiwidiIsImxlZnQiLCJ0b3AiLCJyaWdodCIsImJvdHRvbSIsImdldEJvdW5kc0xlbmd0aEZvclJlZ2lvbiIsInJlZ2lvbkxlbiIsIm1vdmVCeSIsImR4IiwiZHkiLCJNYXRoIiwibWluIiwibWF4IiwidXBkYXRlUmVnaW9uRnJvbUJvdW5kcyIsInJlc2l6ZUJ5IiwicCIsImRlbHRhIiwiY2FsY3VsYXRlRGVsdGEiLCJhdXRvU2l6ZVJlZ2lvbiIsImJlZm9yZVgiLCJiZWZvcmVZIiwiYmVmb3JlV2lkdGgiLCJiZWZvcmVIZWlnaHQiLCJpbWFnZSIsImNlbnRlclgiLCJjZW50ZXJZIiwicm91bmQiLCJ1cGRhdGVCb3VuZHNGcm9tUmVnaW9uIiwiaXNJbnNpZGUiLCJwb2ludCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsWUFBWUMsUUFBUSxnQkFBUixDQUFoQjs7QUFFQSxJQUFJQyxZQUFZLFNBQVpBLFNBQVksQ0FBVUMsSUFBVixFQUFnQjtBQUM5QixPQUFLQyxNQUFMLEdBQWNELEtBQUtDLE1BQUwsSUFBZSxJQUE3QjtBQUNBLE9BQUtDLE1BQUwsR0FBY0wsVUFBVU0sTUFBVixDQUFpQixDQUFqQixFQUFvQixDQUFwQixFQUF1QixDQUF2QixFQUEwQixDQUExQixDQUFkO0FB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QWQsSUFBd0JMLE9BQU9LLE1BQVAsR0FBZ0JULE9BQU84QyxLQUFQLENBQWFyQyxNQUFyRCxDQUFoQjtBQUNEOztBQUVELE9BQUtLLGNBQUwsR0FBc0IsS0FBS2Msd0JBQUwsQ0FBOEIsS0FBS2pCLFFBQW5DLENBQXRCO0FBQ0EsT0FBS0ksZUFBTCxHQUF1QixLQUFLYSx3QkFBTCxDQUE4QixLQUFLZixTQUFuQyxDQUF2QjtBQUNELENBZEQ7O0FBZ0JBZixVQUFVc0IsU0FBVixDQUFvQitCLFFBQXBCLEdBQStCLFVBQVVDLEtBQVYsRUFBaUI7QUFDOUMsU0FBTyxLQUFLbkQsTUFBTCxDQUFZa0QsUUFBWixDQUFxQkMsS0FBckIsQ0FBUDtBQUNELENBRkQ7O0FBSUF0RCxVQUFVSSxNQUFWLEdBQW1CLFVBQVVILElBQVYsRUFBZ0I7QUFDakMsU0FBTyxJQUFJRCxTQUFKLENBQWNDLElBQWQsQ0FBUDtBQUNELENBRkQ7O0FBSUFzRCxPQUFPQyxPQUFQLEdBQWlCeEQsU0FBakIiLCJmaWxlIjoiU2VsZWN0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIFJlY3RhbmdsZSA9IHJlcXVpcmUoJy4vUmVjdGFuZ2xlLmpzJylcblxudmFyIFNlbGVjdGlvbiA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gIHRoaXMudGFyZ2V0ID0gb3B0cy50YXJnZXQgfHwgbnVsbFxuICB0aGlzLmJvdW5kcyA9IFJlY3RhbmdsZS5jcmVhdGUoMCwgMCwgMCwgMClcbiAgdGhpcy5ib3VuZHNQeCA9IFJlY3RhbmdsZS5jcmVhdGUoMCwgMCwgMCwgMClcbiAgdGhpcy5yZWdpb24gPSBSZWN0YW5nbGUuY3JlYXRlKDAsIDAsIDAsIDApXG5cbiAgdGhpcy5pbml0aWFsT3B0cyA9IHtcbiAgICB4OiBvcHRzLngsXG4gICAgeTogb3B0cy55LFxuICAgIHdpZHRoOiBvcHRzLndpZHRoLFxuICAgIGhlaWdodDogb3B0cy5oZWlnaHRcbiAgfVxuXG4gIHRoaXMuYXNwZWN0UmF0aW8gPSBvcHRzLmFzcGVjdFJhdGlvXG4gIHRoaXMubWluV2lkdGggPSBvcHRzLm1pbldpZHRoICE9PSB1bmRlZmluZWQgPyBvcHRzLm1pbldpZHRoIDogMTAwXG4gIHRoaXMubWluSGVpZ2h0ID0gb3B0cy5taW5IZWlnaHQgIT09IHVuZGVmaW5lZCA/IG9wdHMubWluSGVpZ2h0IDogMTAwXG5cbiAgdGhpcy5ib3VuZHNNaW5XaWR0aCA9IDBcbiAgdGhpcy5ib3VuZHNNaW5IZWlnaHQgPSAwXG5cbiAgdGhpcy5fZGVsdGEgPSB7eDogMCwgaDogMH1cbn1cblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoU2VsZWN0aW9uLnByb3RvdHlwZSwge1xuICB4OiB7XG4gICAgZ2V0OiBmdW5jdGlvbiAoKSB7IHJldHVybiB0aGlzLmJvdW5kcy54IH0sXG4gICAgc2V0OiBmdW5jdGlvbiAodikgeyB0aGlzLmJvdW5kcy54ID0gdiB9XG4gIH0sXG4gIHk6IHtcbiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuYm91bmRzLnkgfSxcbiAgICBzZXQ6IGZ1bmN0aW9uICh2KSB7IHRoaXMuYm91bmRzLnkgPSB2IH1cbiAgfSxcbiAgd2lkdGg6IHtcbiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuYm91bmRzLndpZHRoIH0sXG4gICAgc2V0OiBmdW5jdGlvbiAodikgeyB0aGlzLmJvdW5kcy53aWR0aCA9IHYgfVxuICB9LFxuICBoZWlnaHQ6IHtcbiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuYm91bmRzLmhlaWdodCB9LFxuICAgIHNldDogZnVuY3Rpb24gKHYpIHsgdGhpcy5ib3VuZHMuaGVpZ2h0ID0gdiB9XG4gIH0sXG4gIGxlZnQ6IHtcbiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuYm91bmRzLnggfSxcbiAgICBzZXQ6IGZ1bmN0aW9uICh2KSB7XG4gICAgICB0aGlzLmJvdW5kcy5sZWZ0ID0gdlxuICAgIH1cbiAgfSxcbiAgdG9wOiB7XG4gICAgZ2V0OiBmdW5jdGlvbiAoKSB7IHJldHVybiB0aGlzLmJvdW5kcy55IH0sXG4gICAgc2V0OiBmdW5jdGlvbiAodikgeyB0aGlzLmJvdW5kcy50b3AgPSB2IH1cbiAgfSxcbiAgcmlnaHQ6IHtcbiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuYm91bmRzLnJpZ2h0IH0sXG4gICAgc2V0OiBmdW5jdGlvbiAodikgeyB0aGlzLmJvdW5kcy5yaWdodCA9IHYgfVxuICB9LFxuICBib3R0b206IHtcbiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuYm91bmRzLmJvdHRvbSB9LFxuICAgIHNldDogZnVuY3Rpb24gKHYpIHsgdGhpcy5ib3VuZHMuYm90dG9tID0gdiB9XG4gIH1cbn0pXG5cblNlbGVjdGlvbi5wcm90b3R5cGUuZ2V0Qm91bmRzTGVuZ3RoRm9yUmVnaW9uID0gZnVuY3Rpb24gKHJlZ2lvbkxlbikge1xuICByZXR1cm4gcmVnaW9uTGVuIC8gdGhpcy5yZWdpb24ud2lkdGggKiB0aGlzLndpZHRoXG59XG5cblNlbGVjdGlvbi5wcm90b3R5cGUubW92ZUJ5ID0gZnVuY3Rpb24gKGR4LCBkeSkge1xuICB2YXIgYm91bmRzID0gdGhpcy5ib3VuZHNcbiAgdmFyIHRhcmdldCA9IHRoaXMudGFyZ2V0XG5cbiAgYm91bmRzLnggPSBNYXRoLm1pbihNYXRoLm1heChib3VuZHMueCArIGR4LCB0YXJnZXQuYm91bmRzLngpLCB0YXJnZXQuYm91bmRzLnggKyB0YXJnZXQuYm91bmRzLndpZHRoIC0gYm91bmRzLndpZHRoKVxuICBib3VuZHMueSA9IE1hdGgubWluKE1hdGgubWF4KGJvdW5kcy55ICsgZHksIHRhcmdldC5ib3VuZHMueSksIHRhcmdldC5ib3VuZHMueSArIHRhcmdldC5ib3VuZHMuaGVpZ2h0IC0gYm91bmRzLmhlaWdodClcblxuICByZXR1cm4gdGhpcy51cGRhdGVSZWdpb25Gcm9tQm91bmRzKClcbn1cblxuU2VsZWN0aW9uLnByb3RvdHlwZS5yZXNpemVCeSA9IGZ1bmN0aW9uIChkeCwgZHksIHApIHtcbiAgdmFyIGRlbHRhID0gdGhpcy5fZGVsdGFcbiAgdmFyIGFzcGVjdFJhdGlvID0gdGhpcy5hc3BlY3RSYXRpb1xuICB2YXIgYm91bmRzID0gdGhpcy5ib3VuZHNcbiAgdmFyIGJvdW5kc01pbldpZHRoID0gdGhpcy5ib3VuZHNNaW5XaWR0aFxuICB2YXIgYm91bmRzTWluSGVpZ2h0ID0gdGhpcy5ib3VuZHNNaW5IZWlnaHRcbiAgdmFyIHRhcmdldCA9IHRoaXMudGFyZ2V0XG5cbiAgZnVuY3Rpb24gY2FsY3VsYXRlRGVsdGEgKHgsIHkpIHtcbiAgICBkZWx0YS53aWR0aCA9IGJvdW5kcy53aWR0aCArIHhcbiAgICBkZWx0YS5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0ICsgeVxuXG4gICAgZGVsdGEud2lkdGggPSBNYXRoLm1heChib3VuZHNNaW5XaWR0aCwgZGVsdGEud2lkdGgpXG4gICAgZGVsdGEuaGVpZ2h0ID0gTWF0aC5tYXgoYm91bmRzTWluSGVpZ2h0LCBkZWx0YS5oZWlnaHQpXG5cbiAgICBpZiAoYXNwZWN0UmF0aW8pIHtcbiAgICAgIGlmIChkZWx0YS53aWR0aCAvIGRlbHRhLmhlaWdodCA+IGFzcGVjdFJhdGlvKSB7XG4gICAgICAgIGRlbHRhLndpZHRoID0gZGVsdGEuaGVpZ2h0ICogYXNwZWN0UmF0aW9cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbHRhLmhlaWdodCA9IGRlbHRhLndpZHRoIC8gYXNwZWN0UmF0aW9cbiAgICAgIH1cbiAgICB9XG5cbiAgICBkZWx0YS53aWR0aCAtPSBib3VuZHMud2lkdGhcbiAgICBkZWx0YS5oZWlnaHQgLT0gYm91bmRzLmhlaWdodFxuXG4gICAgcmV0dXJuIGRlbHRhXG4gIH1cblxuICBpZiAocFswXSA9PT0gJ24nKSB7XG4gICAgZHkgPSBNYXRoLm1pbihkeSwgdGhpcy50b3AgLSB0YXJnZXQuYm91bmRzLnRvcClcbiAgfSBlbHNlIGlmIChwWzBdID09PSAncycpIHtcbiAgICBkeSA9IE1hdGgubWluKGR5LCB0YXJnZXQuYm91bmRzLmJvdHRvbSAtIHRoaXMuYm90dG9tKVxuICB9XG5cbiAgaWYgKHBbMV0gPT09ICd3Jykge1xuICAgIGR4ID0gTWF0aC5taW4oZHgsIHRoaXMubGVmdCAtIHRhcmdldC5ib3VuZHMubGVmdClcbiAgfSBlbHNlIGlmIChwWzFdID09PSAnZScpIHtcbiAgICBkeCA9IE1hdGgubWluKGR4LCB0YXJnZXQuYm91bmRzLnJpZ2h0IC0gdGhpcy5yaWdodClcbiAgfVxuXG4gIGRlbHRhID0gY2FsY3VsYXRlRGVsdGEoZHgsIGR5KVxuXG4gIHN3aXRjaCAocCkge1xuICAgIGNhc2UgJ253JzpcbiAgICAgIHRoaXMubGVmdCAtPSBkZWx0YS53aWR0aFxuICAgICAgdGhpcy50b3AgLT0gZGVsdGEuaGVpZ2h0XG4gICAgICBicmVha1xuICAgIGNhc2UgJ25lJzpcbiAgICAgIHRoaXMucmlnaHQgKz0gZGVsdGEud2lkdGhcbiAgICAgIHRoaXMudG9wIC09IGRlbHRhLmhlaWdodFxuICAgICAgYnJlYWtcbiAgICBjYXNlICdzdyc6XG4gICAgICB0aGlzLmxlZnQgLT0gZGVsdGEud2lkdGhcbiAgICAgIHRoaXMuYm90dG9tICs9IGRlbHRhLmhlaWdodFxuICAgICAgYnJlYWtcbiAgICBjYXNlICdzZSc6XG4gICAgICB0aGlzLnJpZ2h0ICs9IGRlbHRhLndpZHRoXG4gICAgICB0aGlzLmJvdHRvbSArPSBkZWx0YS5oZWlnaHRcbiAgICAgIGJyZWFrXG4gIH1cblxuICByZXR1cm4gdGhpcy51cGRhdGVSZWdpb25Gcm9tQm91bmRzKClcbn1cblxuU2VsZWN0aW9uLnByb3RvdHlwZS5hdXRvU2l6ZVJlZ2lvbiA9IGZ1bmN0aW9uICgpIHtcbiAgdmFyIHRhcmdldCA9IHRoaXMudGFyZ2V0XG4gIHZhciByZWdpb24gPSB0aGlzLnJlZ2lvblxuICB2YXIgYXNwZWN0UmF0aW8gPSB0aGlzLmFzcGVjdFJhdGlvXG4gIHZhciBpbml0aWFsT3B0cyA9IHRoaXMuaW5pdGlhbE9wdHNcbiAgdmFyIGJlZm9yZVggPSByZWdpb24ueFxuICB2YXIgYmVmb3JlWSA9IHJlZ2lvbi55XG4gIHZhciBiZWZvcmVXaWR0aCA9IHJlZ2lvbi53aWR0aFxuICB2YXIgYmVmb3JlSGVpZ2h0ID0gcmVnaW9uLmhlaWdodFxuXG4gIHJlZ2lvbi54ID0gaW5pdGlhbE9wdHMueCAhPT0gdW5kZWZpbmVkID8gaW5pdGlhbE9wdHMueCA6IDBcbiAgcmVnaW9uLnkgPSBpbml0aWFsT3B0cy55ICE9PSB1bmRlZmluZWQgPyBpbml0aWFsT3B0cy55IDogMFxuXG4gIHJlZ2lvbi53aWR0aCA9IGluaXRpYWxPcHRzLndpZHRoICE9PSB1bmRlZmluZWQgPyBpbml0aWFsT3B0cy53aWR0aCA6IHRhcmdldC5pbWFnZS53aWR0aFxuICByZWdpb24uaGVpZ2h0ID0gaW5pdGlhbE9wdHMuaGVpZ2h0ICE9PSB1bmRlZmluZWQgPyBpbml0aWFsT3B0cy5oZWlnaHQgOiB0YXJnZXQuaW1hZ2UuaGVpZ2h0XG5cbiAgaWYgKGFzcGVjdFJhdGlvKSB7XG4gICAgaWYgKHJlZ2lvbi53aWR0aCAvIHJlZ2lvbi5oZWlnaHQgPiBhc3BlY3RSYXRpbykge1xuICAgICAgcmVnaW9uLndpZHRoID0gcmVnaW9uLmhlaWdodCAqIGFzcGVjdFJhdGlvXG4gICAgfSBlbHNlIHtcbiAgICAgIHJlZ2lvbi5oZWlnaHQgPSByZWdpb24ud2lkdGggLyBhc3BlY3RSYXRpb1xuICAgIH1cbiAgfVxuXG4gIGlmIChpbml0aWFsT3B0cy54ID09PSB1bmRlZmluZWQpIHtcbiAgICByZWdpb24uY2VudGVyWCA9IHRhcmdldC5pbWFnZS53aWR0aCAqIDAuNVxuICB9XG5cbiAgaWYgKGluaXRpYWxPcHRzLnkgPT09IHVuZGVmaW5lZCkge1xuICAgIHJlZ2lvbi5jZW50ZXJZID0gdGFyZ2V0LmltYWdlLmhlaWdodCAqIDAuNVxuICB9XG5cbiAgcmVnaW9uLnJvdW5kKClcblxuICB0aGlzLnVwZGF0ZUJvdW5kc0Zyb21SZWdpb24oKVxuXG4gIHJldHVybiByZWdpb24ueCAhPT0gYmVmb3JlWCB8fFxuICAgIHJlZ2lvbi55ICE9PSBiZWZvcmVZIHx8XG4gICAgcmVnaW9uLndpZHRoICE9PSBiZWZvcmVXaWR0aCB8fFxuICAgIHJlZ2lvbi5oZWlnaHQgIT09IGJlZm9yZUhlaWdodFxufVxuXG5TZWxlY3Rpb24ucHJvdG90eXBlLnVwZGF0ZVJlZ2lvbkZyb21Cb3VuZHMgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciB0YXJnZXQgPSB0aGlzLnRhcmdldFxuICB2YXIgcmVnaW9uID0gdGhpcy5yZWdpb25cbiAgdmFyIGJvdW5kcyA9IHRoaXMuYm91bmRzXG4gIHZhciBiZWZvcmVYID0gcmVnaW9uLnhcbiAgdmFyIGJlZm9yZVkgPSByZWdpb24ueVxuICB2YXIgYmVmb3JlV2lkdGggPSByZWdpb24ud2lkdGhcbiAgdmFyIGJlZm9yZUhlaWdodCA9IHJlZ2lvbi5oZWlnaHRcblxuICByZWdpb24ueCA9IHRhcmdldC5pbWFnZS53aWR0aCAqIChib3VuZHMueCAtIHRhcmdldC5ib3VuZHMueCkgLyB0YXJnZXQuYm91bmRzLndpZHRoXG4gIHJlZ2lvbi55ID0gdGFyZ2V0LmltYWdlLmhlaWdodCAqIChib3VuZHMueSAtIHRhcmdldC5ib3VuZHMueSkgLyB0YXJnZXQuYm91bmRzLmhlaWdodFxuXG4gIHJlZ2lvbi53aWR0aCA9IHRhcmdldC5pbWFnZS53aWR0aCAqIChib3VuZHMud2lkdGggLyB0YXJnZXQuYm91bmRzLndpZHRoKVxuICByZWdpb24uaGVpZ2h0ID0gdGFyZ2V0LmltYWdlLmhlaWdodCAqIChib3VuZHMuaGVpZ2h0IC8gdGFyZ2V0LmJvdW5kcy5oZWlnaHQpXG5cbiAgcmVnaW9uLnJvdW5kKClcblxuICByZXR1cm4gcmVnaW9uLnggIT09IGJlZm9yZVggfHxcbiAgICByZWdpb24ueSAhPT0gYmVmb3JlWSB8fFxuICAgIHJlZ2lvbi53aWR0aCAhPT0gYmVmb3JlV2lkdGggfHxcbiAgICByZWdpb24uaGVpZ2h0ICE9PSBiZWZvcmVIZWlnaHRcbn1cblxuU2VsZWN0aW9uLnByb3RvdHlwZS51cGRhdGVCb3VuZHNGcm9tUmVnaW9uID0gZnVuY3Rpb24gKCkge1xuICB2YXIgdGFyZ2V0ID0gdGhpcy50YXJnZXRcbiAgdmFyIHJlZ2lvbiA9IHRoaXMucmVnaW9uXG4gIHZhciBib3VuZHMgPSB0aGlzLmJvdW5kc1xuXG4gIGlmICh0YXJnZXQuaW1hZ2UpIHtcbiAgICBib3VuZHMueCA9IHRhcmdldC5ib3VuZHMueCArIHRhcmdldC5ib3VuZHMud2lkdGggKiAocmVnaW9uLnggLyB0YXJnZXQuaW1hZ2Uud2lkdGgpXG4gICAgYm91bmRzLnkgPSB0YXJnZXQuYm91bmRzLnkgKyB0YXJnZXQuYm91bmRzLmhlaWdodCAqIChyZWdpb24ueSAvIHRhcmdldC5pbWFnZS5oZWlnaHQpXG4gICAgYm91bmRzLndpZHRoID0gdGFyZ2V0LmJvdW5kcy53aWR0aCAqIChyZWdpb24ud2lkdGggLyB0YXJnZXQuaW1hZ2Uud2lkdGgpXG4gICAgYm91bmRzLmhlaWdodCA9IHRhcmdldC5ib3VuZHMuaGVpZ2h0ICogKHJlZ2lvbi5oZWlnaHQgLyB0YXJnZXQuaW1hZ2UuaGVpZ2h0KVxuICB9XG5cbiAgdGhpcy5ib3VuZHNNaW5XaWR0aCA9IHRoaXMuZ2V0Qm91bmRzTGVuZ3RoRm9yUmVnaW9uKHRoaXMubWluV2lkdGgpXG4gIHRoaXMuYm91bmRzTWluSGVpZ2h0ID0gdGhpcy5nZXRCb3VuZHNMZW5ndGhGb3JSZWdpb24odGhpcy5taW5IZWlnaHQpXG59XG5cblNlbGVjdGlvbi5wcm90b3R5cGUuaXNJbnNpZGUgPSBmdW5jdGlvbiAocG9pbnQpIHtcbiAgcmV0dXJuIHRoaXMuYm91bmRzLmlzSW5zaWRlKHBvaW50KVxufVxuXG5TZWxlY3Rpb24uY3JlYXRlID0gZnVuY3Rpb24gKG9wdHMpIHtcbiAgcmV0dXJuIG5ldyBTZWxlY3Rpb24ob3B0cylcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTZWxlY3Rpb25cbiJdfQ==